[delayed_gcode START_UP]
initial_duration: 5
gcode:
    G28
    LED_HOTEND_OFF
    LED_LOGO_OFF

[delayed_gcode turn_off_leds]
gcode:
    LED_HOTEND_OFF

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : False ; use custom park coordinates for x,y [True/False]
variable_custom_park_x    : 0.0   ; custom x position; value must be within your defined min and max of X
variable_custom_park_y    : 0.0   ; custom y position; value must be within your defined min and max of Y
variable_custom_park_dz   : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
variable_retract          : 1.0   ; the value to retract while PAUSE
variable_cancel_retract   : 5.0   ; the value to retract while CANCEL_PRINT
variable_speed_retract    : 35.0  ; retract speed in mm/s
variable_unretract        : 1.0   ; the value to unretract while RESUME
variable_speed_unretract  : 35.0  ; unretract speed in mm/s
variable_speed_hop        : 15.0  ; z move speed in mm/s
variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : False ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
variable_park_at_cancel_x : None  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
variable_park_at_cancel_y : None  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
# !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
variable_use_fw_retract  : False ; use fw_retraction instead of the manual version [True/False]
gcode:

[gcode_macro START_PRINT]
description: Start G-Code
gcode:
    {% set BED_TEMP = params.BED_TEMP_FL|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(195)|float %}
    {% set BED_TEMP_EXTRA = 5 %}
    
    LED_HOTEND_ON
    UPDATE_DELAYED_GCODE ID=turn_off_leds DURATION=600

    G21 ;
    M220 S100 ;Reset Feedrate
    M221 S100 ;Reset Flowrate
    G90 ; use absolute coordinates
    M83 ; extruder relative mode
    M107 ; stop fan
    M106 S128 ;
    M140 S{BED_TEMP + BED_TEMP_EXTRA} ; wait for bed temp
    M190 S{BED_TEMP + BED_TEMP_EXTRA} ; wait for bed temp
    M104 S{EXTRUDER_TEMP} ; wait for extruder temp
    M109 S{EXTRUDER_TEMP} ; wait for extruder temp

    BED_MESH_CLEAR
    G28 ; home all
    BED_MESH_PROFILE LOAD=default
    M400 ; Wait finsih moves
    M107 ; stop fan
    G92 E0 ; Reset Extruder count
    G1 X-100 Y100 Z10 F6000;
    G0 E2 F300;
    G92 E0 ; Reset Extruder count
    #G1 Z0 F300
    #SET_GCODE_OFFSET Z=0.000 MOVE=1

[gcode_macro END_PRINT]
description: End G-Code
gcode:
    G91 ; use relative coordinates
    M83 ; extruder relative mode
    G92 E0 ;
    G1 E-2 Z5 F6000 ;
    G28;
    G90 ; use absolute coordinates
    M104 S0 ; turn off temperature
    M140 S0 ; turn off heatbed
    M106 S0
    M107 ; turn off fan
    M84 X Y E ;Disable all steppers but Z
    NEOPIXEL_GREEN
    LED_HOTEND_OFF

[gcode_macro llit_lamina]
gcode:
    SET_GCODE_OFFSET Z=-0.430 MOVE=1

[gcode_macro llit_pei_fi]
gcode:
    SET_GCODE_OFFSET Z=-0.330 MOVE=1

[gcode_macro llit_pei_gr]
gcode:
    SET_GCODE_OFFSET Z=0.0 MOVE=1

[gcode_macro APARTAR_Z]
gcode:
    G91
    G1 Z50
    G90

[gcode_macro APARCAR]
gcode:
    G28
    G91
    G1 Y+148
    G90

[gcode_macro ORIGEN_XYZ]
gcode:
    G28

[gcode_macro POS_NETEJA]
gcode:
    G28
    G90
    G1 Y0 Z350 F6000;

[gcode_macro G29]
gcode:
  BED_MESH_PROFILE LOAD=default

[gcode_macro G29_crear]
gcode:
  BED_MESH_CLEAR
  G28
  BED_MESH_CALIBRATE PROFILE=default METHOD=automatic

[gcode_macro M900]
gcode:

    {% set factor_k = params.KFACTOR|default("0.2")|float %} # define un parámetro para la macro con un valor por defecto y de tipo float (coma flotante de 16bits).
    {% if factor_k is not none %}
      M117 {factor_k}
      {action_respond_info((factor_k|string))}
      {action_respond_info((rawparams|string))}
      #M117 valor raw: {rawparams}
      #SET_PRESSURE_ADVANCE ADVANCE={factor_k} # se le pasa el valor del parámetro.
    {% else %}
      M117 ERROR
    {% endif %}

[gcode_macro Escalfar_PLA]
gcode:
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=60
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=160

[gcode_macro Escalfar_PETG]
gcode:
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=65
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=170

[gcode_macro Escalfar_PAGF]
gcode:
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=80
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200


[gcode_macro Escalfar_ABS]
gcode:
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=90
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200

[gcode_macro Refredar]
gcode:
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0


[gcode_macro Filament_load]
gcode:
    {% set speed = params.S|default(1200)|int %}
    {% set length = params.L|default(100)|int %}
    {% set temperature = params.T|default(205)|int %}
    {% set extruder = params.E|default('extruder')|string %}

    ACTIVATE_EXTRUDER EXTRUDER={extruder|string}
    M109 S{temperature} T{extruder}
    G91
    G1 E{length} F{speed}
    M104 S0 T{extruder}

[gcode_macro Filament_unload]
gcode:
    {% set speed = params.S|default(500)|int %}
    {% set length = params.L|default(100)|int %}
    {% set temperature = params.T|default(205)|int %}
    {% set extruder = params.E|default('extruder')|string %}

    ACTIVATE_EXTRUDER EXTRUDER={extruder|string}
    M109 S{temperature} T{extruder}
    G91
    G1 E-{length} F{speed}
    M104 S0 T{extruder}

