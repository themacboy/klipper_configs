#   _____             __ _                       _   _                
#  / ____|           / _(_)                     | | (_)                
# | |     ___  _ __ | |_ _  __ _ _   _ _ __ __ _| |_ _  ___  _ __  ___ 
# | |    / _ \| '_ \|  _| |/ _` | | | | '__/ _` | __| |/ _ \| '_ \/ __|
# | |___| (_) | | | | | | | (_| | |_| | | | (_| | |_| | (_) | | | \__ \
#  \_____\___/|_| |_|_| |_|\__, |\__,_|_|  \__,_|\__|_|\___/|_| |_|___/
#                           __/ |                                      
#                          |___/    
#
# Klipper Configurations - Anycubic Predator powered by Makerbase Monster 8 v.2   
#
# TheMacBoy
#
# This file contains common pin mappings for MKS Monster8
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "USB for communication".

# The "make flash" command does not work on the MKS Monster8. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "mks_monster8.bin" on an SD card or Udisk and then restart the
# MKS Monster8 with that SD card or Udisk.

# See docs/Config_Reference.md for a description of parameters.


########################################
# Included Files
########################################

# Machine definitions
[include ./configs/*.cfg]


########################################
# Printer Settings
########################################

[printer]
kinematics: delta
max_velocity: 200
max_accel: 1500 #5000
max_accel_to_decel: 1500
square_corner_velocity: 5.0
max_z_velocity: 200 #100
max_z_accel: 500 #5000
print_radius: 190
minimum_z_position: -2
#delta_radius: 227.4


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PB2,  EXP1_3=PE11, EXP1_5=PD9, EXP1_7=PE15, EXP1_9=<GND>,
    EXP1_2=PE10, EXP1_4=PD10, EXP1_6=PD8, EXP1_8=PE7,  EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE9, EXP2_5=PE8, EXP2_7=PB11,  EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PA4, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<3.3v>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp1"


########################################
# X Stepper Motor & Driver Settings
########################################

[stepper_a]
step_pin: PC14
dir_pin: PC13
enable_pin: !PC15
microsteps: 32
rotation_distance: 40
endstop_pin: PA14	
homing_speed: 30
second_homing_speed: 10
homing_retract_dist: 3.0
homing_retract_speed: 10
#position_endstop: 415.0
#arm_length = 345.0

########################################
# Y Stepper Motor & Driver Settings
########################################

[stepper_b]
step_pin: PE5
dir_pin: PE4
enable_pin: !PC15
microsteps: 32
rotation_distance: 40
endstop_pin: PA15

########################################
# Z Stepper Motor & Driver Settings
########################################

[stepper_c]
step_pin: PE1
dir_pin: PE0
enable_pin: !PE2
microsteps: 32
rotation_distance: 40
endstop_pin: PB13

########################################
# TMC2009 configuration
########################################

[tmc2209 stepper_a]
uart_pin: PE6
run_current: 1.4
#hold_current: 0.600
sense_resistor: 0.110
stealthchop_threshold: 999999 

[tmc2209 stepper_b]
uart_pin: PE3
run_current: 1.4
#hold_current: 0.600
sense_resistor: 0.110
stealthchop_threshold: 999999 

[tmc2209 stepper_c]
uart_pin: PB7
run_current: 1.4
#hold_current: 0.600
sense_resistor: 0.110
stealthchop_threshold: 999999 

[tmc2209 extruder]
uart_pin: PB3
run_current: 0.9
#hold_current: 0.600
sense_resistor: 0.110
stealthchop_threshold: 0


########################################
# Extruder & Driver Settings
########################################

[extruder]
step_pin: PB5
dir_pin: !PB4
enable_pin: !PB6
microsteps: 32
rotation_distance: 8.05
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB1
sensor_type: ATC Semitec 104NT-4-R025H42G # Generic 3950 - EPCOS 100K B57560G104F - NTC 100K MGB18-104F39050L32 - NTC 100K MGB18-104F39050L32 - ATC Semitec 104NT-4-R025H42G
sensor_pin: PC1
min_temp: 5
max_temp: 290
min_extrude_temp: 185
max_extrude_cross_section: 50
max_extrude_only_distance: 800
max_extrude_only_velocity: 60
max_extrude_only_accel: 1500
#pressure_advance: 0.02
pressure_advance_smooth_time: 0.010
#pressure_advance_lookahead_time: 0.010
#control = pid
#pid_kp = 17.501
#pid_ki = 0.711
#pid_kd = 107.630


########################################
# Bed Settings
########################################

[heater_bed]
heater_pin: PB10
sensor_pin: PC0
sensor_type: EPCOS 100K B57560G104F
min_temp: 0
max_temp: 120
#control = pid
#pid_kp = 64.044
#pid_ki = 3.812
#pid_kd = 268.984


########################################
# Filament Sensor Settings
########################################

[filament_switch_sensor filament_sensor]
pause_on_runout: True
runout_gcode: 
	M600 ; pause macro
insert_gcode:
	#
switch_pin: !PA13


########################################
# Fans Settings
########################################

#[multi_pin layer_fan]
#pins: PB1,PC14

#[fan]
#pin: multi_pin:layer_fan
##pin: PB1 
#max_power: 1.0
#cycle_time: 0.010
#hardware_pwm: True # False
#kick_start_time: 0.100


#[output_pin CPAP_pin] 
#pin: PA10 
#pwm: True
#hardware_pwm: False
#value: 0 
#cycle_time: 0.010
#shutdown_value: 0

[fan]
pin: !PA2
max_power: 1.0
cycle_time: 0.005
hardware_pwm: False # False True
kick_start_time: 0.300

[output_pin WS7040_power]
pin: PA3
pwm: false
value: 0
shutdown_value: 0

[delayed_gcode WS7040_init]
initial_duration: 10
gcode:
  SET_PIN PIN=WS7040_power VALUE=1


#[fan_generic  extruder_partfan_0]
#pin: PB1
#max_power: 1
#shutdown_speed:
#cycle_time: 0.020
#hardware_pwm: false
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:

#[fan_generic  extruder_partfan_1]
#pin: PC14
#max_power: 1
#shutdown_speed:
#cycle_time: 0.020
#hardware_pwm: false
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:

#[gcode_macro M106]
#gcode:
#
#    {% if params.S is defined %}
#      {% set param_s = params.S|int %}
#      {% if param_s == 255 %}
#        {% set realspeed = 1 %}
#      {% elif param_s == 0 %}
#        {% set realspeed = 0 %}
#      {% else %}
#        {% set realspeed = param_s/255 %}
#      {% endif %}
#    {% else %}
#      {% set realspeed = 1 %}
#    {% endif %}
#
#
#    {% if params.P is defined %}
#      {% if params.S is defined %}
#        SET_FAN_SPEED FAN=extruder_partfan_{params.P|int} SPEED={realspeed}
#      {% else %}
#        SET_FAN_SPEED FAN=extruder_partfan_{params.P|int} SPEED=1
#      {% endif %}
#    {% else %}
#
#      {% if params.S is defined %}
#        SET_FAN_SPEED FAN=extruder_partfan_0 SPEED={realspeed}
#        SET_FAN_SPEED FAN=extruder_partfan_1 SPEED={realspeed}
#      {% else %}
#        SET_FAN_SPEED FAN=extruder_partfan_0 SPEED=1
#        SET_FAN_SPEED FAN=extruder_partfan_1 SPEED=1
#      {% endif %}
#    {% endif %}
#
#[gcode_macro M107]
#gcode:
#    {% if params.P is defined %}
#      SET_FAN_SPEED FAN=extruder_partfan_{params.P|int} SPEED=0
#    {% else %}
#      SET_FAN_SPEED FAN=extruder_partfan_0 SPEED=0
#      SET_FAN_SPEED FAN=extruder_partfan_1 SPEED=0 
#    {% endif %}


[heater_fan Hotend] 
pin: PB0 #PE5
heater_temp: 60
fan_speed: 1.0
heater: extruder

#[controller_fan Trigorilla_pro]*
#pin: PD6
#max_power: 1.0
#shutdown_speed: 0.0
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.
#fan_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver is active.
#   The default is 1.0
#idle_timeout:
#   The amount of time (in seconds) after a stepper driver or heater
#   was active and the fan should be kept running. The default
#   is 30 seconds.
#idle_speed:
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when a heater or stepper driver was active and
#   before the idle_timeout is reached. The default is fan_speed.
#heater: extruder
#stepper:
#   Name of the config section defining the heater/stepper that this fan
#   is associated with. If a comma separated list of heater/stepper names
#   is provided here, then the fan will be enabled when any of the given
#   heaters/steppers are enabled. The default heater is "extruder", the
#   default stepper is all of them.


########################################
# Probe Settings
########################################

[probe]
pin: PB12 #PA8
x_offset: 0
y_offset: -15
speed: 5
lift_speed: 5
samples: 3
samples_result: average
sample_retract_dist: 5
samples_tolerance: 0.02
samples_tolerance_retries: 5


########################################
# Delta Calibration & Mesh Settings
########################################

[delta_calibrate]
radius: 190
horizontal_move_z: 20
speed: 30

[bed_mesh]
speed: 30
horizontal_move_z: 20
mesh_radius: 174
mesh_origin: 0,0
round_probe_count: 19 #15
algorithm: bicubic
bicubic_tension: 0.2
fade_start: 1
fade_end: 10
fade_target: 0

########################################
# Temperature Controls
########################################

[verify_heater extruder]
max_error: 240
hysteresis: 5

[verify_heater heater_bed]
max_error: 120
hysteresis: 5


########################################
# Firmware Retraction Settings
########################################

#[firmware_retraction]
#retract_length: 0.7
#retract_speed: 40
#unretract_extra_length: 0.05
#unretract_speed: 40


########################################
# Input Shaper Settings
########################################
[input_shaper]
shaper_freq_x: 39
shaper_type_x: 2hump_ei
shaper_freq_y: 39
shaper_type_y: 2hump_ei


########################################
# G-Code Macros & Events
########################################

[idle_timeout]
timeout: 1800

[save_variables]
filename: ~/Predator_data/config/variables.cfg

[gcode_arcs]

[pause_resume]
recover_velocity: 30

[display_status]

[respond]
default_type: echo

[exclude_object]

[virtual_sdcard]
path: ~/Predator_data/gcodes
on_error_gcode:
    CANCEL_PRINT


[endstop_phase]

[endstop_phase stepper_a]
endstop_align_zero: false

[endstop_phase stepper_b]
endstop_align_zero: false

[endstop_phase stepper_c]
endstop_align_zero: false 


########################################
# MCU Settings
########################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_21004D000A51323332353039-if00
restart_method: command
baud: 256000 # 230400 115200

[temperature_sensor MKS_Monster8]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 80

[temperature_sensor Servidor_impressores]
sensor_type: temperature_host
min_temp: 0
max_temp: 85


########################################
# LED Settings
########################################

#[output_pin LED_Hotend]
#pin: PE12
#pwm: False
#value: 0

#[output_pin LED_Logo]
#pin: PD11
#pwm: False
#value: 1

[force_move]
enable_force_move: True
#   Set to true to enable FORCE_MOVE and SET_KINEMATIC_POSITION
#   extended G-Code commands. The default is false.

############################################################################################################################
############################################################################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [printer]
#*# delta_radius = 227.610315
#*#
#*# [stepper_a]
#*# arm_length = 440.000000
#*# position_endstop = 437.782052
#*# angle = 209.707937
#*#
#*# [stepper_b]
#*# arm_length = 440.000000
#*# position_endstop = 438.494270
#*# angle = 329.717982
#*#
#*# [stepper_c]
#*# arm_length = 440.000000
#*# position_endstop = 438.131415
#*# angle = 90.000000
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 46.300
#*# pid_ki = 1.816
#*# pid_kd = 295.162
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 16.692
#*# pid_ki = 0.890
#*# pid_kd = 78.243
#*#
#*# [probe]
#*# z_offset = 11.528
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 63/128
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 23/128
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 49/128
#*#
#*# [bed_mesh Predator_G10]
#*# version = 1
#*# points =
#*# 	  -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158, -0.440158
#*# 	  -0.528383, -0.528383, -0.528383, -0.528383, -0.528383, -0.528383, -0.508812, -0.543623, -0.568647, -0.546098, -0.465756, -0.393950, -0.363100, -0.358260, -0.358260, -0.358260, -0.358260, -0.358260, -0.358260
#*# 	  -0.520424, -0.520424, -0.520424, -0.520424, -0.520424, -0.522004, -0.548466, -0.574811, -0.602060, -0.593668, -0.548400, -0.471661, -0.446318, -0.420963, -0.467813, -0.467813, -0.467813, -0.467813, -0.467813
#*# 	  -0.504386, -0.504386, -0.504386, -0.504386, -0.510552, -0.495974, -0.533482, -0.554249, -0.570655, -0.577867, -0.552378, -0.512940, -0.469674, -0.479974, -0.489885, -0.497873, -0.497873, -0.497873, -0.497873
#*# 	  -0.485279, -0.485279, -0.485279, -0.496737, -0.517595, -0.506902, -0.547989, -0.562310, -0.570716, -0.574565, -0.542544, -0.493456, -0.471593, -0.539740, -0.519203, -0.497815, -0.447132, -0.447132, -0.447132
#*# 	  -0.536964, -0.536964, -0.485900, -0.454846, -0.477214, -0.488112, -0.540359, -0.576901, -0.582829, -0.567740, -0.538192, -0.517297, -0.481627, -0.424442, -0.454369, -0.468807, -0.457844, -0.354830, -0.354830
#*# 	  -0.559867, -0.559867, -0.513064, -0.485026, -0.513805, -0.513553, -0.565038, -0.606174, -0.577536, -0.527597, -0.517316, -0.522078, -0.502550, -0.431521, -0.425469, -0.438268, -0.422690, -0.339047, -0.339047
#*# 	  -0.585938, -0.585938, -0.525832, -0.496563, -0.507907, -0.533853, -0.581373, -0.601056, -0.552060, -0.489175, -0.482343, -0.521635, -0.495901, -0.458875, -0.421799, -0.470274, -0.446233, -0.357269, -0.357269
#*# 	  -0.646674, -0.646674, -0.562739, -0.540172, -0.557293, -0.608530, -0.646305, -0.656637, -0.620721, -0.522915, -0.501759, -0.528964, -0.505173, -0.489816, -0.445890, -0.412033, -0.405367, -0.364281, -0.364281
#*# 	  -0.633968, -0.621075, -0.558544, -0.566570, -0.590999, -0.652717, -0.673161, -0.669736, -0.639881, -0.566730, -0.528716, -0.524288, -0.518453, -0.525205, -0.502524, -0.499257, -0.518304, -0.418391, -0.370482
#*# 	  -0.650250, -0.650250, -0.608775, -0.594687, -0.613596, -0.656814, -0.704601, -0.693674, -0.619253, -0.611865, -0.559703, -0.523304, -0.509722, -0.513666, -0.516401, -0.533188, -0.555370, -0.459496, -0.459496
#*# 	  -0.660711, -0.660711, -0.675752, -0.569484, -0.598569, -0.646489, -0.684777, -0.654327, -0.521362, -0.643508, -0.592263, -0.544282, -0.530727, -0.509578, -0.522498, -0.543832, -0.571257, -0.547717, -0.547717
#*# 	  -0.611050, -0.611050, -0.588548, -0.581207, -0.589264, -0.632428, -0.703527, -0.747606, -0.719763, -0.667965, -0.609262, -0.598892, -0.570181, -0.530897, -0.534371, -0.543621, -0.554168, -0.560933, -0.560933
#*# 	  -0.507656, -0.507656, -0.495226, -0.537840, -0.571305, -0.610304, -0.690397, -0.727226, -0.704413, -0.637573, -0.587289, -0.604225, -0.608292, -0.585342, -0.568559, -0.543975, -0.567147, -0.539569, -0.539569
#*# 	  -0.476623, -0.476623, -0.476623, -0.507049, -0.521862, -0.567822, -0.623700, -0.640474, -0.520811, -0.617032, -0.581107, -0.587699, -0.604060, -0.605740, -0.604862, -0.563687, -0.552146, -0.552146, -0.552146
#*# 	  -0.429151, -0.429151, -0.429151, -0.429151, -0.420233, -0.449910, -0.519505, -0.568252, -0.570406, -0.568642, -0.568955, -0.566169, -0.572668, -0.569679, -0.553881, -0.542763, -0.542763, -0.542763, -0.542763
#*# 	  -0.240727, -0.240727, -0.240727, -0.240727, -0.240727, -0.312186, -0.401396, -0.480181, -0.518668, -0.529365, -0.531314, -0.550785, -0.575685, -0.530865, -0.480156, -0.480156, -0.480156, -0.480156, -0.480156
#*# 	  -0.120615, -0.120615, -0.120615, -0.120615, -0.120615, -0.120615, -0.242728, -0.373158, -0.442400, -0.479047, -0.479999, -0.487533, -0.467290, -0.430782, -0.430782, -0.430782, -0.430782, -0.430782, -0.430782
#*# 	  -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258, -0.406258
#*# x_count = 19
#*# y_count = 19
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -173.97
#*# max_x = 173.97
#*# min_y = -173.97
#*# max_y = 173.97
#*#
#*# [delta_calibrate]
#*# height0 = 11.528
#*# height0_pos = 68198.000,68312.000,68256.000
#*# height1 = 11.528
#*# height1_pos = 86567.667,86900.000,58505.000
#*# height2 = 11.528
#*# height2_pos = 66111.667,98761.667,66241.667
#*# height3 = 11.528
#*# height3_pos = 58841.667,83513.000,83544.000
#*# height4 = 11.528
#*# height4_pos = 65647.333,65655.333,88178.667
#*# height5 = 11.528
#*# height5_pos = 80772.333,59484.333,80752.333
#*# height6 = 11.528
#*# height6_pos = 92861.000,65987.000,65871.000
